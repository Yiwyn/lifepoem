+++
title = '字段变化记录功能-从业务层面到技术层面的设计演进'

date = 2025-06-07T16:10:11+08:00

categories = ["设计"]

tags = ["功能设计"]

+++



### 由字段变化记录功能引发的从业务层面到技术层面的设计演进



> 背景：
>
> 在诸多系统配置类/信息展示类页面中，多数会需要记录和展示关键字段的变化，如：开关状态，通常需要记录：状态修改时间、原始值、新值、变更说明。但是实际开发中，我们的状态值往往是码值，例如 开-00 关-01，在记录存储中则面临一个问题，需要对类似的字段进行转义，因为我们需要展示。
>
> 现在要把字段记录功能进行统一，即统一保存入口和读取反显。此为背景，将围绕此背景展开技术层面的代码设计。





#### 面临的问题

- ##### 在保存变更的时候，如果需要进行转义的字段如何处理

  - 方案一：保存的时候只保留原值，读取的时候在逻辑中进行转义。
  - 方案二：保存的时候转义并落库，读取的时候直接读。

  以上两个方案都存在一定的局限性，若使用方案一则会导致在读取的时候需要根据业务场景做不同的转义逻辑；同样方案二则会导致在存储的时候也需要根据业务场景做逻辑转义；

  这种情况下，如果做成同一个接口，则堆叠的逻辑越来越多，难以维护。如果分散开来开发，则相同的处理分散到不同的接口，同样难以维护。

- ##### 字段转义的灵活性

  - 我们在字段转义中，每个人有不同的习惯，或者说不同的字段类型有不同的处理形式，如枚举、字典表等形式，这就很考验设计的灵活性，需要考虑到转义形式扩展。




---



#### 设计目标

- 从分散到统一，记录变更应该是一件事，有统一的入口，所以在记录变更行为需要和业务功能解耦。
- 需要简单易用，开发者应该可以很快上手使用这个功能。
- 可扩展性要强，开发者无论是修改亦或是新增都应该在很短的时间内完成。
- 性能要在接受范围之内。



#### 设计思路

- ##### 领域/业务区分

  - 使用类注解进行领域/业务类的标识。 在Entity（数据库实体）定义业务类型。

- ##### 新老对象的对比

  - 使用注解的形式对需要记录变更的字段进行标识。
  
- ##### 【*】码值转义如何实现

  这个部分是设计的难点，正式因为转义的不确定性，才会扩展到这个问题。其实我们需要做的是如何在入口即定义好转义，即预先定义事件，在字段明确发生变化后进行触发。
  
  - 预设事件、后置事件执行
  - 特定处理句柄handle
  - 转义相关功能灵活组合                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  



#### 设计实现

首先大概了解一下流程：

![image-20250609140739644](https://filestore.lifepoem.fun/know/202506091407724.png)

##### 痛点分析

从上面的流程图可以分析数据准备阶段是比较简单的。根据字段寻找对应字段处理事件是比较难处理的一个点，在设计成统一入口后，对于传进来的类是未知的，所以直接在Entity中添加方法是不可取的（获取不到真实类型不能调用方法）。

这里考虑将事件和注解结合，如果注解和字段以及字段处理事件绑定那问题就会得到有效解决。

但是随之而来的问题是注解如何和事件进行结合。



---



#### 代码设计



首先我们定义一个实体类-商店【Shop】接下来将从Shop类中字段修改进行设计实现

```java
package com.yiwyn.domain;

import lombok.Data;

@Data
public class Shop {

    private String shopId;

    private String shopName;

    private String shopAddress;

    private String shopPhone;

    private String shopEmail;

    private String openStatus;
}
```





- ##### 实体类注解

```java
package com.yiwyn.utils.modify.anno.modify;


import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

// 类注解
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface ModifyType {

    // 领域/业务 类型
    String value() default "";

}

// ===============================================================分割线


import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

// 字段注解
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
public @interface ModifyEventField {

    // 字段类型
    String filedType();
}


```



在有了基本的类注解和字段注解后，我们可以使用AOP、反射等技术来根据字段注解获取字段并进行字段比较。





